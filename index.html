<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>S&amp;SYS SALES PORTAL - 전문 고객 관계 및 영업 관리 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 외부 CSS -->
  <link rel="stylesheet" href="integrated-crm-style.css?v=3.0.0">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- XLSX (SheetJS) for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

  <!-- Chart.js for Analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <!-- FullCalendar for Calendar Integration -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js'></script>

  <!-- Marked.js (마크다운 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<!-- 로그인 모달 -->
<div id="loginModal">
  <div class="modal-content">
    <div class="login-header">
      <i class="fas fa-user-circle"></i>
      <h2>S&amp;SYS SALES PORTAL 로그인</h2>
    </div>
    <div class="form-group">
      <label><i class="fas fa-envelope"></i> 이메일</label>
      <input type="email" id="loginUser" placeholder="name@example.com">
    </div>
    <div class="form-group">
      <label><i class="fas fa-lock"></i> 비밀번호</label>
      <input type="password" id="loginPw" style="font-family: 'Arial', sans-serif; letter-spacing: 2px;">
      <div class="forgot-pw-link">
        <a href="#" id="forgotPasswordLink">비밀번호를 잊으셨나요?</a>
      </div>
    </div>
    <div class="btn-row">
      <button id="loginConfirmBtn" class="primary-btn">
        <i class="fas fa-sign-in-alt"></i> 로그인
      </button>
    </div>
    <p id="loginError" style="color:red; margin-top:5px; font-size:0.85em;"></p>
  </div>
</div>

<!-- 비밀번호 찾기 모달 -->
<div id="forgotPasswordModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeForgotPasswordModal()">&times;</span>
    <h2>비밀번호 초기화</h2>
    <p>가입한 이메일 주소를 입력하시면 비밀번호 재설정 링크를 보내드립니다.</p>
    <div class="form-group">
      <label>이메일</label>
      <input type="email" id="resetEmail" placeholder="name@example.com">
    </div>
    <div class="btn-row">
      <button id="sendResetLinkBtn" class="primary-btn">초기화 링크 전송</button>
      <button onclick="closeForgotPasswordModal()" class="secondary-btn">취소</button>
    </div>
    <p id="resetEmailStatus"></p>
  </div>
</div>

<!-- 최초 로그인 시 비밀번호 변경 모달 -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="document.getElementById('changePasswordModal').style.display='none';">&times;</span>
    <h2>비밀번호 변경</h2>
    <p>최초 로그인 시 보안을 위해 비밀번호를 변경해 주세요.</p>
    <div class="form-group">
      <label>현재 비밀번호</label>
      <input type="password" id="currentPassword" placeholder="현재 비밀번호 입력">
    </div>
    <div class="form-group">
      <label>새 비밀번호</label>
      <input type="password" id="newPassword" placeholder="새 비밀번호 입력 (6자 이상)">
    </div>
    <div class="form-group">
      <label>새 비밀번호 확인</label>
      <input type="password" id="confirmPassword" placeholder="새 비밀번호 다시 입력">
    </div>
    <div class="btn-row">
      <button id="changePasswordBtn" class="primary-btn">비밀번호 변경</button>
      <button onclick="document.getElementById('changePasswordModal').style.display='none';" class="secondary-btn">취소</button>
    </div>
    <p id="changePasswordStatus"></p>
  </div>
</div>

<!-- 메인 레이아웃 -->
<div class="main-layout hidden" id="mainLayout">
  <!-- 좌측 네비게이션 -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img
        class="sidebar-logo"
        src="https://pds.saramin.co.kr/company/logo/202002/24/q676t0_a5ak-ya4cjo_logo.jpg"
        alt="S&amp;SYS 로고"
      >
      <h3><i class="fas fa-briefcase"></i> <span>S&amp;SYS SALES PORTAL</span></h3>
    </div>
    
    <ul class="nav-menu">
      <li class="nav-item active" data-view="dashboard">
        <a href="#"><i class="fas fa-chart-line"></i> <span>대시보드</span></a>
      </li>
      <li class="nav-item" data-view="customers">
        <a href="#"><i class="fas fa-users"></i> <span>고객 관리</span></a>
      </li>
      <li class="nav-item" data-view="sales">
        <a href="#"><i class="fas fa-won-sign"></i> <span>영업 안건</span></a>
      </li>
      <li class="nav-item" data-view="pipeline">
        <a href="#"><i class="fas fa-funnel-dollar"></i> <span>영업 파이프라인</span></a>
      </li>
      <li class="nav-item" data-view="communications">
        <a href="#"><i class="fas fa-comments"></i> <span>커뮤니케이션</span></a>
      </li>
      <li class="nav-item" data-view="calendar">
        <a href="#"><i class="fas fa-calendar-alt"></i> <span>일정 관리</span></a>
      </li>
      <li class="nav-item" data-view="analytics">
        <a href="#"><i class="fas fa-chart-bar"></i> <span>분석 및 리포트</span></a>
      </li>
      <li class="nav-item" data-view="userManagement" id="navUserManagement" style="display:none;">
        <a href="#"><i class="fas fa-user-shield"></i> <span>사용자 관리</span></a>
      </li>
    </ul>
    
    <div class="sidebar-footer">
      <div class="user-info">
        <i class="fas fa-user"></i>
        <span id="sidebarUserName">-</span>
      </div>
      <button id="logoutBtn" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> <span>로그아웃</span>
      </button>
    </div>
  </nav>

  <!-- 메인 컨텐츠 영역 -->
  <main class="main-content" id="mainContent">
    <!-- 상단 헤더 -->
    <header class="top-header">
      <div class="header-left">
        <button class="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <h1 id="pageTitle">대시보드</h1>
      </div>
      <div class="header-right">
        <div class="header-actions">
          <button class="icon-btn" onclick="showNotifications()">
            <i class="fas fa-bell"></i>
            <span class="badge" id="notificationBadge">0</span>
          </button>
          <button class="icon-btn" onclick="quickAddCustomer()">
            <i class="fas fa-plus-circle"></i>
          </button>
          <div class="user-menu">
            <span id="currentUserName">-</span>
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div id="connectionStatus" class="connection-status">
          <i class="fas fa-wifi"></i> <span>연결 확인 중...</span>
        </div>
      </div>
    </header>

    <!-- 동적 콘텐츠 영역 -->
    <div class="content-area" id="contentArea">
      <!-- 대시보드 뷰 -->
      <div id="dashboardView" class="view-content active">
        <!-- 통합 KPI 카드들 -->
        <div class="dashboard-grid">
          <div class="kpi-card">
            <div class="kpi-icon blue">
              <i class="fas fa-box"></i>
            </div>
            <div class="kpi-content">
              <h3>수주량</h3>
              <p class="kpi-value" id="orderVolume">₩0</p>
              <span class="kpi-change positive">0% 전월 대비</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon green">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="kpi-content">
              <h3>진행중 프로젝트</h3>
              <p class="kpi-value" id="ongoingProjects">0</p>
              <span class="kpi-change positive">0% 전월 대비</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon orange">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="kpi-content">
              <h3>예정 프로젝트</h3>
              <p class="kpi-value" id="plannedProjects">0</p>
              <span class="kpi-change positive">0% 전월 대비</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon purple">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="kpi-content">
              <h3>수주 확률</h3>
              <p class="kpi-value" id="orderProbability">0%</p>
              <span class="kpi-change negative">0% 전월 대비</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon red">
              <i class="fas fa-briefcase"></i>
            </div>
            <div class="kpi-content">
              <h3>열린 안건</h3>
              <p class="kpi-value" id="openDeals">0</p>
              <span class="kpi-change positive">0% 전월 대비</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon teal">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="kpi-content">
              <h3>등록고객수</h3>
              <p class="kpi-value" id="registeredCustomers">0</p>
              <span class="kpi-change positive">0% 전월 대비</span>
            </div>
          </div>
        </div>

        <!-- 차트 영역 -->
        <div class="dashboard-charts">
          <div class="chart-container">
            <h3>단계별 안건 현황</h3>
            <canvas id="productOrderChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>월별 수주 추이</h3>
            <canvas id="monthlyOrderChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>담당자별 안건 분포</h3>
            <canvas id="shipyardProjectChart"></canvas>
          </div>
        </div>

        <!-- 최근 활동 -->
        <div class="recent-activities">
          <h3>최근 활동</h3>
          <div id="activityList" class="activity-list">
            <!-- 동적으로 추가됨 -->
          </div>
        </div>
      </div>

      <!-- 고객 관리 뷰 -->
      <div id="customersView" class="view-content">
        <div class="view-header">
          <div class="view-actions">
            <button class="primary-btn" onclick="openCustomerModal()">
              <i class="fas fa-plus"></i> 신규 고객
            </button>
            <button class="secondary-btn" onclick="importCustomers()">
              <i class="fas fa-file-import"></i> 가져오기
            </button>
            <button class="secondary-btn" onclick="exportCustomers()">
              <i class="fas fa-file-export"></i> 내보내기
            </button>
          </div>
        </div>
        <div class="filters customer-filters">
          <div class="filter-group search-group">
            <label for="customerSearch">검색</label>
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="customerSearch" placeholder="고객 검색..." oninput="applyCustomerFilters()">
            </div>
          </div>
          <div class="filter-group">
            <label for="companyFilter">회사명</label>
            <input type="text" id="companyFilter" list="companyOptions" placeholder="회사명 선택 또는 입력" oninput="applyCustomerFilters()">
            <datalist id="companyOptions"></datalist>
          </div>
          <div class="filter-group">
            <label for="managerFilter">담당자</label>
            <input type="text" id="managerFilter" list="managerOptions" placeholder="담당자 선택 또는 입력" oninput="applyCustomerFilters()">
            <datalist id="managerOptions"></datalist>
          </div>
          <div class="filter-group">
            <label for="mainCustomerFilter">주요고객</label>
            <input type="text" id="mainCustomerFilter" list="mainCustomerOptions" placeholder="Y / N" oninput="applyCustomerFilters()">
            <datalist id="mainCustomerOptions">
              <option value="Y"></option>
              <option value="N"></option>
            </datalist>
          </div>
          <div class="filter-group">
            <label for="emailFilter">이메일</label>
            <input type="text" id="emailFilter" list="emailOptions" placeholder="이메일 선택 또는 입력" oninput="applyCustomerFilters()">
            <datalist id="emailOptions"></datalist>
          </div>
        </div>


<!-- 고객 테이블 -->
<div class="data-table-container">
  <table class="data-table" id="customerTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAllCustomers"></th>
        <th class="col-no">NO. <i class="fas fa-sort"></i></th>
        <th>회사명 <i class="fas fa-sort"></i></th>
        <th>담당자 <i class="fas fa-sort"></i></th>
        <th>지역 <i class="fas fa-sort"></i></th>
        <th>전화1 <i class="fas fa-sort"></i></th>
        <th>전화2 <i class="fas fa-sort"></i></th>
        <th>이메일 <i class="fas fa-sort"></i></th>
        <th>주요고객 <i class="fas fa-sort"></i></th>
        <th>등록자 <i class="fas fa-sort"></i></th>
        <th>등록일 <i class="fas fa-sort"></i></th>
        <th>비고 <i class="fas fa-sort"></i></th>
        <th>히스토리</th>
        <th>편집</th>
      </tr>
    </thead>
    <tbody id="customerTableBody">
      <!-- 동적으로 추가됨 -->
    </tbody>
  </table>
</div>

        <!-- 페이지네이션 -->
        <div class="pagination">
          <button class="page-btn" onclick="previousPage()">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="page-info">1-10 of 100</span>
          <button class="page-btn" onclick="nextPage()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- 영업 안건 뷰 -->
      <div id="salesView" class="view-content">
        <!-- 상태 카드 -->
        <div class="status-summary">
          <div class="status-card">
            <h3>전체 안건</h3>
            <div class="count" id="countTotal">0</div>
          </div>
          <div class="status-card">
            <h3>진행중</h3>
            <div class="count" id="countProgress">0</div>
          </div>
          <div class="status-card">
            <h3>완료</h3>
            <div class="count" id="countComplete">0</div>
          </div>
          <div class="status-card">
            <h3>실패</h3>
            <div class="count" id="countFailed">0</div>
          </div>
          <div class="status-card">
            <h3>이번달 등록</h3>
            <div class="count" id="countThisMonth">0</div>
          </div>
        </div>

        <!-- 필터 영역 -->
        <div class="filters">
          <div class="filter-group">
            <label>NO.</label>
            <input type="text" id="filterNo" oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label>지역</label>
            <input type="text" id="filterRegion" oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label>제품</label>
            <select id="filterProduct" onchange="applyFilters()">
              <option value="">전체</option>
              <option value="설비제어">설비제어</option>
              <option value="배전반">배전반</option>
              <option value="BWMS">BWMS</option>
              <option value="ECO">ECO</option>
              <option value="기타">기타</option>
            </select>
          </div>
          <div class="filter-group">
            <label>프로젝트명</label>
            <input type="text" id="filterProject" oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label>유형</label>
            <select id="filterType" onchange="applyFilters()">
              <option value="">전체</option>
              <option value="신조">신조</option>
              <option value="개조">개조</option>
            </select>
          </div>
          <div class="filter-group">
            <label>고객사</label>
            <input type="text" id="filterCustomer" oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label>담당자</label>
            <input type="text" id="filterManager" oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label>진행현황</label>
            <select id="filterStatus" onchange="applyFilters()">
              <option value="">전체</option>
              <option value="초기상담">초기상담</option>
              <option value="제안서제출">제안서제출</option>
              <option value="견적진행">견적진행</option>
              <option value="계약협상">계약협상</option>
              <option value="계약완료">계약완료</option>
              <option value="진행보류">진행보류</option>
              <option value="실주">실주</option>
            </select>
          </div>
          <div class="filter-group">
            <label style="visibility:hidden;">&nbsp;</label>
            <button id="loadBtn" style="padding:6px 10px;">전체조회</button>
          </div>
        </div>

        <!-- 테이블 영역 -->
        <div class="table-container" id="tableContainer">
          <div class="table-wrapper" id="tableWrapper">
            <table id="salesTable">
              <thead>
                <tr>
                  <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
                  <th data-field="no">NO.<div class="col-resizer"></div></th>
                  <th data-field="region">지역<div class="col-resizer"></div></th>
                  <th data-field="registDate">등록일<div class="col-resizer"></div></th>
                  <th data-field="product">제품<div class="col-resizer"></div></th>
                  <th data-field="projectName">프로젝트명<div class="col-resizer"></div></th>
                  <th data-field="type">유형<div class="col-resizer"></div></th>
                  <th data-field="bidAmount">입찰금액<div class="col-resizer"></div></th>
                  <th data-field="currency">통화<div class="col-resizer"></div></th>
                  <th data-field="customer">고객사<div class="col-resizer"></div></th>
                  <th data-field="manager">담당자<div class="col-resizer"></div></th>
                  <th data-field="date">DATE<div class="col-resizer"></div></th>
                  <th data-field="progress">진행현황<div class="col-resizer"></div></th>
                  <th data-field="remark">REMARK<div class="col-resizer"></div></th>
                  <th data-field="status">현황<div class="col-resizer"></div></th>
                  <th data-field="modifiedDate">수정일<div class="col-resizer"></div></th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>

        <!-- 하단 버튼 -->
        <div class="bottom-controls">
          <button id="addRowBtn">행 추가</button>
          <button id="deleteRowBtn">선택 행 삭제</button>
          <button id="saveBtn">저장</button>
          <button id="downloadExcelBtn">엑셀 다운로드</button>
          <input type="file" id="uploadExcelInput" style="display:none;" accept=".xlsx,.xls">
          <button id="uploadExcelBtn">엑셀 업로드</button>
          <button id="historyBtn">히스토리 조회</button>
          <button id="clearHistoryBtn">히스토리 전체 삭제</button>
          <button id="managerStatusBtn" style="background:#ff6b6b;">담당자별 현황</button>
          <button id="salesAnalysisBtn" style="background:#17a2b8;">영업 지표 분석</button>
        </div>
      </div>

      <!-- 영업 파이프라인 뷰 -->
      <div id="pipelineView" class="view-content">
        <div class="view-header">
          <div class="view-actions">
            <button class="primary-btn" onclick="openDealModal()">
              <i class="fas fa-plus"></i> 신규 거래
            </button>
            <div class="pipeline-stats">
              <span>총 거래: <strong id="totalDeals">0</strong></span>
              <span>총 가치: <strong id="totalValue">₩0</strong></span>
            </div>
          </div>
          <div class="view-filters">
            <select id="pipelineFilter" onchange="filterPipeline()">
              <option value="">전체 담당자</option>
            </select>
            <select id="dateFilter" onchange="filterPipeline()">
              <option value="">전체 기간</option>
              <option value="week">이번 주</option>
              <option value="month">이번 달</option>
              <option value="quarter">이번 분기</option>
            </select>
          </div>
        </div>

        <!-- 칸반 보드 -->
        <div class="kanban-board" id="kanbanBoard">
          <div class="kanban-column" data-stage="lead">
            <div class="column-header">
              <h3>리드</h3>
              <span class="column-count">0</span>
            </div>
            <div class="column-body" ondrop="dropDeal(event)" ondragover="allowDrop(event)">
              <!-- 딜 카드들 -->
            </div>
          </div>
          
          <div class="kanban-column" data-stage="contact">
            <div class="column-header">
              <h3>연락중</h3>
              <span class="column-count">0</span>
            </div>
            <div class="column-body" ondrop="dropDeal(event)" ondragover="allowDrop(event)">
              <!-- 딜 카드들 -->
            </div>
          </div>
          
          <div class="kanban-column" data-stage="proposal">
            <div class="column-header">
              <h3>제안서</h3>
              <span class="column-count">0</span>
            </div>
            <div class="column-body" ondrop="dropDeal(event)" ondragover="allowDrop(event)">
              <!-- 딜 카드들 -->
            </div>
          </div>
          
          <div class="kanban-column" data-stage="negotiation">
            <div class="column-header">
              <h3>협상중</h3>
              <span class="column-count">0</span>
            </div>
            <div class="column-body" ondrop="dropDeal(event)" ondragover="allowDrop(event)">
              <!-- 딜 카드들 -->
            </div>
          </div>
          
          <div class="kanban-column" data-stage="closed">
            <div class="column-header">
              <h3>성사</h3>
              <span class="column-count">0</span>
            </div>
            <div class="column-body" ondrop="dropDeal(event)" ondragover="allowDrop(event)">
              <!-- 딜 카드들 -->
            </div>
          </div>
        </div>
      </div>

      <!-- 커뮤니케이션 뷰 -->
      <div id="communicationsView" class="view-content">
        <div class="comm-layout">
          <!-- 왼쪽: 고객 목록 -->
          <div class="comm-sidebar">
            <div class="comm-search">
              <input type="text" placeholder="고객 검색..." oninput="searchCommCustomers()">
            </div>
            <div class="customer-list" id="commCustomerList">
              <!-- 고객 목록 -->
            </div>
          </div>
          
          <!-- 오른쪽: 커뮤니케이션 이력 -->
          <div class="comm-main">
            <div class="comm-header" id="commHeader">
              <div class="comm-header-text">
                <h3>고객을 선택해주세요</h3>
              </div>
              <button class="secondary-btn" onclick="openCustomerModal()">
                <i class="fas fa-user-plus"></i> 고객 추가
              </button>
            </div>
            <div class="comm-timeline" id="commTimeline">
              <!-- 타임라인 -->
            </div>
            <div class="comm-input" id="commInput" style="display:none;">
              <select id="commType">
                <option value="email">이메일</option>
                <option value="phone">전화</option>
                <option value="meeting">미팅</option>
                <option value="note">메모</option>
              </select>
              <textarea id="commContent" placeholder="내용을 입력하세요..."></textarea>
              <button class="primary-btn" onclick="addCommunication()">
                <i class="fas fa-paper-plane"></i> 기록 추가
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 캘린더 뷰 -->
      <div id="calendarView" class="view-content">
        <div class="calendar-header">
          <div class="calendar-actions">
            <button class="primary-btn" onclick="openEventModal()">
              <i class="fas fa-plus"></i> 일정 추가
            </button>
            <button class="secondary-btn" onclick="syncCalendar()">
              <i class="fas fa-sync"></i> 동기화
            </button>
          </div>
          <div class="calendar-filters">
            <label for="calendarFilterMeeting">
              <input type="checkbox" id="calendarFilterMeeting" data-event-type="meeting" checked> 미팅
            </label>
            <label for="calendarFilterCall">
              <input type="checkbox" id="calendarFilterCall" data-event-type="call" checked> 전화
            </label>
            <label for="calendarFilterTask">
              <input type="checkbox" id="calendarFilterTask" data-event-type="task" checked> 작업
            </label>
          </div>
        </div>
        <div id="calendar"></div>
      </div>

      <!-- 분석 및 리포트 뷰 -->
      <div id="analyticsView" class="view-content">
        <div class="analytics-placeholder">
          <i class="fas fa-chart-bar"></i>
          <p>준비중</p>
        </div>
      </div>

      <!-- 사용자 관리 뷰 -->
      <div id="userManagementView" class="view-content">
        <div class="user-management-page">
          <div class="user-management-header">
            <h2><i class="fas fa-user-shield"></i> 사용자 관리</h2>
            <p>S&amp;SYS SALES PORTAL의 계정과 권한을 관리합니다. 이 메뉴는 관리자만 접근할 수 있습니다.</p>
          </div>
          <div class="user-management-panel">
            <div class="user-table-wrapper">
              <table class="user-table">
                <thead>
                  <tr>
                    <th>선택</th>
                    <th>이메일</th>
                    <th>이름</th>
                    <th>부서</th>
                    <th>권한</th>
                  </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
              </table>
            </div>
            <div class="btn-row user-table-actions">
              <button id="deleteSelectedUsersBtn" class="danger-btn">선택 사용자 삭제</button>
              <button id="saveUserChangesBtn" class="primary-btn">변경사항 저장</button>
            </div>
            <div class="user-management-divider"></div>
            <div class="user-management-add">
              <h3>사용자 추가</h3>
              <p class="user-modal-guide">Firebase Authentication에 등록된 이메일만 추가할 수 있습니다.</p>
              <div class="user-form-grid">
                <div class="form-group">
                  <label>이메일</label>
                  <input type="email" id="newUserEmail" placeholder="name@example.com">
                </div>
                <div class="form-group">
                  <label>이름</label>
                  <input type="text" id="newUserName" placeholder="홍길동">
                </div>
                <div class="form-group">
                  <label>부서</label>
                  <input type="text" id="newUserDepartment" placeholder="영업팀">
                </div>
                <div class="form-group">
                  <label>권한</label>
                  <select id="newUserRole">
                    <option value="user">일반</option>
                    <option value="manager">매니저</option>
                    <option value="admin">관리자</option>
                  </select>
                </div>
              </div>
              <div class="btn-row user-form-actions">
                <button id="addUserConfirmBtn" class="primary-btn">추가</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- 모달들 -->
<!-- 고객 추가/수정 모달 -->
<div id="customerModal" class="modal">
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h2 id="customerModalTitle">신규 고객 등록</h2>
      <span class="modal-close" onclick="closeCustomerModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>NO. <span class="required">*</span></label>
          <input type="text" id="custNo" required>
        </div>
        <div class="form-group">
          <label>회사명 <span class="required">*</span></label>
          <input type="text" id="custCompany" required>
        </div>
        <div class="form-group">
          <label>담당자</label>
          <input type="text" id="custManager">
        </div>
        <div class="form-group">
          <label>지역</label>
          <select id="custRegion">
            <option value="국내">국내</option>
            <option value="중국">중국</option>
            <option value="일본">일본</option>
            <option value="싱가포르">싱가포르</option>
            <option value="동남아">동남아</option>
            <option value="인도">인도</option>
            <option value="중동">중동</option>
            <option value="그리스">그리스</option>
            <option value="유럽">유럽</option>
            <option value="북미">북미</option>
            <option value="남미">남미</option>
            <option value="기타">기타</option>
          </select>
        </div>
        <div class="form-group">
          <label>전화1</label>
          <input type="tel" id="custPhone1">
        </div>
        <div class="form-group">
          <label>전화2</label>
          <input type="tel" id="custPhone2">
        </div>
        <div class="form-group">
          <label>이메일</label>
          <input type="email" id="custEmail">
        </div>
        <div class="form-group">
          <label>주요고객</label>
          <select id="custMainCustomer">
            <option value="N">N</option>
            <option value="Y">Y</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label>주소</label>
          <input type="text" id="custAddress">
        </div>
        <div class="form-group">
          <label>DATE</label>
          <input type="date" id="custDate">
        </div>
        <div class="form-group">
          <label>등록일</label>
          <input type="date" id="custRegistDate" readonly>
        </div>
        <div class="form-group full-width">
          <label>REMARK</label>
          <textarea id="custRemark" rows="3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="secondary-btn" onclick="closeCustomerModal()">취소</button>
      <button class="primary-btn" onclick="saveCustomer()">저장</button>
    </div>
  </div>
</div>
<!-- 거래 추가/수정 모달 -->
<div id="dealModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="dealModalTitle">신규 거래 등록</h2>
      <span class="modal-close" onclick="closeDealModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>거래명 <span class="required">*</span></label>
        <input type="text" id="dealName" required>
      </div>
      <div class="form-group">
        <label>고객 <span class="required">*</span></label>
        <select id="dealCustomer" required>
          <option value="">고객 선택</option>
        </select>
        <input type="text" id="dealCustomerManual" placeholder="직접 입력 (선택)">
        <small class="field-hint">목록에 없다면 직접 입력하세요.</small>
      </div>
      <div class="form-group">
        <label>예상 금액</label>
        <input type="number" id="dealValue" placeholder="0">
      </div>
      <div class="form-group">
        <label>예상 종료일</label>
        <input type="date" id="dealCloseDate">
      </div>
      <div class="form-group">
        <label>단계</label>
        <select id="dealStage">
          <option value="lead">리드</option>
          <option value="contact">연락중</option>
          <option value="proposal">제안서</option>
          <option value="negotiation">협상중</option>
          <option value="closed">성사</option>
        </select>
      </div>
      <div class="form-group">
        <label>확률 (%)</label>
        <input type="number" id="dealProbability" min="0" max="100" value="20">
      </div>
      <div class="form-group">
        <label>설명</label>
        <textarea id="dealDescription" rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="secondary-btn" onclick="closeDealModal()">취소</button>
      <button class="primary-btn" onclick="saveDeal()">저장</button>
    </div>
  </div>
</div>

<!-- 일정 추가/수정 모달 -->
<div id="eventModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="eventModalTitle">일정 추가</h2>
      <span class="modal-close" onclick="closeEventModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>제목 <span class="required">*</span></label>
        <input type="text" id="eventTitle" required>
      </div>
      <div class="form-group">
        <label>유형</label>
        <select id="eventType">
          <option value="meeting">미팅</option>
          <option value="call">전화</option>
          <option value="task">작업</option>
          <option value="other">기타</option>
        </select>
      </div>
      <div class="form-group">
        <label>고객</label>
        <select id="eventCustomer">
          <option value="">고객 선택</option>
        </select>
        <input type="text" id="eventCustomerManual" placeholder="직접 입력 (선택)">
        <small class="field-hint">목록에 없다면 직접 입력하세요.</small>
      </div>
      <div class="form-group">
        <label>시작 시간</label>
        <input type="datetime-local" id="eventStart">
      </div>
      <div class="form-group">
        <label>종료 시간</label>
        <input type="datetime-local" id="eventEnd">
      </div>
      <div class="form-group">
        <label>설명</label>
        <textarea id="eventDescription" rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="secondary-btn" onclick="closeEventModal()">취소</button>
      <button class="primary-btn" onclick="saveEvent()">저장</button>
    </div>
  </div>
</div>

<!-- 히스토리 모달 -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeHistoryModal()">&times;</span>
    <h2>변경 이력</h2>
    <ul class="history-list" id="historyList"></ul>
  </div>
</div>

<!-- 엑셀 업로드 모달 -->
<div id="excelModal" class="modal">
  <div class="modal-content">
    <h3>엑셀 업로드 방식 선택</h3>
    <div class="btn-row">
      <button id="excelReplaceBtn">기존 삭제 후 업로드</button>
      <button id="excelAppendBtn">추가만</button>
      <button id="excelCancelBtn">취소</button>
    </div>
  </div>
</div>

<!-- 고객 가져오기 모달 -->
<div id="customerImportModal" class="modal">
  <div class="modal-content">
    <h3>가져오기 방식 선택</h3>
    <p class="modal-description">전체 업로드를 선택하면 기존 고객 데이터가 모두 대체됩니다.</p>
    <div class="btn-row">
      <button id="customerImportFullBtn" class="danger-btn">전체 업로드</button>
      <button id="customerImportPartialBtn" class="primary-btn">부분 업로드</button>
      <button id="customerImportCancelBtn" class="secondary-btn">취소</button>
    </div>
  </div>
</div>

<!-- 내용 보기 모달 -->
<div id="contentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeContentModal()">&times;</span>
    <h2>전체 내용</h2>
    <div id="contentText"></div>
  </div>
</div>

<!-- 담당자별 현황 모달 -->
<div id="managerStatusModal" class="modal-background">
  <div class="modal-content">
    <span class="close" onclick="closeManagerStatusModal()">&times;</span>
    <button style="position:absolute; right:45px; top:10px; font-size:0.85em; background:#666; color:#fff; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;"
            onclick="toggleManagerStatusFullscreen()">전체화면</button>
    <h2>담당자별 영업 현황</h2>
    <div style="margin-bottom: 10px;">
      <label>정렬: </label>
      <select id="managerStatusSort" onchange="sortManagerStatus()">
        <option value="name">이름순</option>
        <option value="total">총 안건순</option>
        <option value="progress">진행중순</option>
        <option value="complete">완료순</option>
      </select>
    </div>
    <div id="managerStatusList" style="max-height: 600px; overflow-y: auto;">
      <!-- 담당자별 현황이 여기에 표시됩니다 -->
    </div>
  </div>
</div>

<!-- 영업 지표 분석 모달 -->
<div id="salesAnalysisModal" class="modal-background">
  <div class="modal-content" style="width: 95%; max-width: 1400px;">
    <span class="close" onclick="closeSalesAnalysisModal()">&times;</span>
    <h2>영업 지표 분석 대시보드</h2>
    
    <!-- 기간 필터 -->
    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
      <label style="font-weight: bold; margin-right: 10px;">분석 기간:</label>
      <select id="analysisDateFilter" onchange="updateSalesAnalysis()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
        <option value="all">전체 기간</option>
        <option value="thisYear">올해</option>
        <option value="lastYear">작년</option>
        <option value="thisQuarter">이번 분기</option>
        <option value="lastQuarter">지난 분기</option>
        <option value="thisMonth">이번달</option>
        <option value="lastMonth">지난달</option>
        <option value="last3Months">최근 3개월</option>
        <option value="last6Months">최근 6개월</option>
      </select>
      
      <label style="margin-left: 20px; font-weight: bold;">제품별:</label>
      <select id="analysisProductFilter" onchange="updateSalesAnalysis()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
        <option value="all">전체 제품</option>
        <option value="설비제어">설비제어</option>
        <option value="배전반">배전반</option>
        <option value="BWMS">BWMS</option>
        <option value="ECO">ECO</option>
        <option value="기타">기타</option>
      </select>
    </div>
    
    <!-- 핵심 지표 카드 -->
    <div id="kpiCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <!-- KPI 카드들이 여기에 동적으로 생성됩니다 -->
    </div>
    
    <!-- 차트 영역 -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
      <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">진행 현황별 금액 분포</h3>
        <canvas id="progressChart" width="400" height="300"></canvas>
      </div>
      <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">월별 영업 추이</h3>
        <canvas id="monthlyTrendChart" width="400" height="300"></canvas>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
      <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">제품별 매출 비중</h3>
        <canvas id="productChart" width="400" height="300"></canvas>
      </div>
      <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px; color: #333;">고객사별 TOP 10</h3>
        <canvas id="customerChart" width="400" height="300"></canvas>
      </div>
    </div>
    
    <!-- 상세 테이블 -->
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h3 style="margin-bottom: 15px; color: #333;">진행 현황별 상세 분석</h3>
      <div id="analysisDetailTable" style="overflow-x: auto;">
        <!-- 상세 테이블이 여기에 생성됩니다 -->
      </div>
    </div>
    
    <!-- 인사이트 영역 -->
    <div style="margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
      <h3 style="margin-bottom: 10px; color: #1976d2;">주요 인사이트</h3>
      <div id="salesInsights" style="line-height: 1.8;">
        <!-- 인사이트가 여기에 동적으로 생성됩니다 -->
      </div>
    </div>
  </div>
</div>

<!-- 알림 패널 -->
<div id="notificationPanel" class="notification-panel">
  <div class="panel-header">
    <h3>알림</h3>
    <button class="close-btn" onclick="hideNotifications()">&times;</button>
  </div>
  <div class="notification-list" id="notificationList">
    <!-- 알림 목록 -->
  </div>
</div>

<!-- 로딩 오버레이 -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
</div>

<!-- 메인 스크립트 -->
<script src="integrated-crm-script.js?v=3.0.0"></script>
</body>
</html>